{% extends "structure.html" %} <!-- INHEREITING FROM STRUCTURE.HTML-->
{%block main %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='css/user_profile.css') }}">
<!-- SESSION VARIABLES-->
<div id="profile picture">
    <h1>{{host_account[0]}}</h1>
    <img id="profile_picture"
        src="{{url_for('static', filename='#UserData/' + account_name + '/profile/profile_pic.jpg')}} " width='200' height='200' 
    />  
     
    <div id="add_new_profile_picture"></div>
    <textarea id="w3review" maxlength="40" name="w3review" rows="4" cols="40" disabled>{{profile_bio}}</textarea>
    

    
    <br>
</div>

<div id="non_host_add_remove">
</div>


<div class="dropdown">
    <br>
    <button onclick="get_following()" class="dropbtn">Following  {{friend_count}}</button>
    <div id="my_following_dropdown" class="dropdown-content">
    </div>
</div>
<div class="dropdown">
    <br>
    <button onclick="get_followers()" class="dropbtn">Followers {{follow_count}}</button>
    <div id="my_followers_dropdown" class="dropdown-content">
    </div>
</div>

<div class="container">
    {%for i in range(0, username_len )%}
    <div class="col" style="width: 90%">
        <div class="card mb-4 shadow-sm border-dark mb-3">
            <div class="card-body">
                <!-- TODO: CHANGE TO AN HREF TO GO TO THEIR PROFILE -->
                <div > <!--CARD TITLE-->                  
                    <a href="/{{usernames_list[i]}}">{{usernames_list[i]}}</a>
                                            
                    <!--DAILY -->
                    {% if daily_left == 0 %}
                    <span id="daily_vote  "><button class="btn btn-outline-secondary disabled"><a href="/vote/{{file_ids_list[i]}}/Daily">D: {{day_votes[i]}}</a></button></span>
                    {% else %}
                    <span id="daily_vote  "><button class="btn btn-outline-success"><a href="/vote/{{file_ids_list[i]}}/Daily">D: {{day_votes[i]}}</a></button></span>
                    {% endif %}

                    <!--MONTHLY -->
                    {% if monthly_left == 0 %}
                    <span id="monthly_vote  "><button class="btn btn-outline-secondary disabled"><a href="/vote/{{file_ids_list[i]}}/Monthly">M: {{month_votes[i]}}</a></button></span>
                    {% else %}
                    <span id="monthly_vote  "><button class="btn btn-outline-success"><a href="/vote/{{file_ids_list[i]}}/Monthly">M: {{month_votes[i]}}</a></button></span>
                    {% endif %}

                    <!--YEARLY -->
                    {% if yearly_left == 0 %}
                    <span id="yearly_vote  "><button class="btn btn-outline-secondary disabled"><a href="/vote/{{file_ids_list[i]}}/Yearly">Y: {{year_votes[i]}}</a></button></span>
                    {% else %}
                    <span id="yearly_vote  "><button class="btn btn-outline-success"><a href="/vote/{{file_ids_list[i]}}/Yearly">Y: {{year_votes[i]}}</a></button></span>
                    {% endif %}
                </div>

                
                <!-- POST TEXT -->
                <div id="text_span">
                    {% if lengths_of_text_files[i] > 300 %}
                        {{text_list[i][:300]}}...
                        <div>
                            <a href="/{{usernames_list[i]}}_{{paths_list[i]}}-post_page">see more...</a>
                        </div>
                    {% else %}
                        {{text_list[i]}}
                        <div>
                            <a href="/{{usernames_list[i]}}_{{paths_list[i]}}-post_page">see more...</a>
                        </div>
                    {% endif %}            
                </div>
                
                <!-- POST IMAGE -->
                {% if image_path_list[i] != "" %}
                <img onclick="enlargeImg()" id="post_pic" src="{{url_for('static', filename=image_path_list[i])}} " width='400' height='200' />
                {% endif %}
                <!--PROFILE PICTURE-->
                <img class="text-right position-absolute top-0 end-0" id="profile_picture" src="{{url_for('static', filename='#UserData/' + usernames_list[i] + '/profile/profile_pic.jpg')}} " width='30' height='30' />


                <!-- PUTTING SHIT AT THE BOTTOM -->
                <div><br /></div>
                <div class=" card-footer d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <button class="btn btn-secondary" type="button" onclick="reply_modal_toggle({{file_ids_list[i]}})" aria-expanded="false">
                            REPLY
                        </button>
                    </small>
                    <small class="text-muted" id="post_details">
                        <a href="{{usernames_list[i]}}_{{paths_list[i]}}-post_page">ID:{{file_ids_list[i]}} </a>

                        {% if age_18_list[i] == "older_18" %}
                        <u>18+</u>
                        {% endif %}
                        Source:<a href='{{source_list[i]}}'>{{source_list[i]}}</a>
                        {% if post_sources_list[i] != "N-A" %}
                        Referencing: {{post_sources_list[i]}}

                        {% endif %}
                        {{dates_list[i]}}

                    </small>
                </div>
            </div>
        </div>
    </div>
    {%endfor%}

</div>

<!-- reply_modal  -->
<div id="reply_modal" class="modal">

    <!-- Modal content -->
    <div class="modal-content">
        <form action="upload" method="POST" enctype="multipart/form-data">
            <div>
                <label for="textbox">Whats on your mind? (10000 chars) [NO EMOJIS FOR NOW SORRY LOL]</label>
                <br>
                <textarea id="textbox" name="textbox" rows="7" cols="50" maxlength="10000"></textarea>

            </div>

            <div class="custom-file">
                <!-- .mp4,.csv, .onnx,-->
                <input type="file" class="custom-file-input" name="file" accept=".png, .jpeg, .jpg, .pdf" id="dataset_file">
                <input type="text" id="hidden_file_size" name="hidden_file_size" placeholder="auto" size="1" value="">
                <label class="custom-file-label" for="file">PNG/JPG/CSV/ONNX/MP4/PDF</label>

                <div id="dataset_return_message">

                </div>
            </div>

            <div>                
                <label class="custom-file-label" for="file">Replying to File Id</label>
                <input type="number" id="reply_external_source" name="external_source" value="" >(this person will get 5% of what your winnings)              
            </div>
            
            <!-- EXTERNAL LINK -->
            <div>
                <input type="checkbox" name="button_reply_external_source_link" value="button_reply_external_source_link" onchange="reply_enable_external_link()">
                <label><b>Source:</b></label>
                <input id="reply_external_source_link" name="external_source_link" type="url" placeholder="Enter Source LINK">
            </div>

            <div>
                <input type="checkbox" id="older_18" name="older_18" value="older_18">
                <label for="">This is for adults only 18+? (SEVERE PENALITIES FOR GETTING THIS WRONG)</label><br>
            </div>

            <br>

            <button class="btn btn-primary" name="upload" value="upload">UPLOAD</button>

            FILE SIZE MUST BE < 10 GIGS
        </form>
    </div>
</div>
<!-- The Modal -->



<div id="dataset_return_message">

</div>


<script>
    
    document.getElementById("reply_external_source_link").disabled = true; // setting default to disabled
    d_votes_left = '{{ daily_votes_left }}';
    m_votes_left = '{{ monthly_votes_left }}';
    y_votes_left = '{{ yearly_votes_left }}';
    day_vote_list = '{{day_votes}}'
    month_vote_list = '{{month_votes}}'
    year_vote_list = '{{year_votes}}'
    balance = '{{balance}}'

    document.getElementById("daily_votes_left").innerHTML = `DAILY VOTES: ${d_votes_left}`;
    document.getElementById("monthly_votes_left").innerHTML = `MONTHLY VOTES: ${m_votes_left}`;
    document.getElementById("yearly_votes_left").innerHTML = `YEARLY VOTES: ${y_votes_left}`;
    document.getElementById("user_balance").innerHTML = `BALANCE: ${balance}`;
    document.getElementById("daily_votes_left").innerHTML = `DAILY VOTES: ${d_votes_left}`;
    document.getElementById("index_daily").innerHTML = 'DAILY POOL: ${{dailypool}}';
    document.getElementById("index_monthly").innerHTML = 'MONTHLY POOL: ${{monthlypool }}';
    document.getElementById("index_yearly").innerHTML = 'YEARLY POOL: ${{yearlypool }}';
    
    s_list = '{{source_list}}';
    console.log("source_list", s_list);

    function get_wanted_string_following(string) {
        // console.log(string, string.length);
        if (string.length == 0 || string.length == 2){
            return "NO FOLLOWING";
        }
        // console.log(string)

        first_apost_split = string.split(";")[1];
        //console.log(first_apost_split)

        second_ampr_split = first_apost_split.split("&")[0];
        // console.log(second_ampr_split)

        return second_ampr_split
    }
    function get_wanted_string_followers(string){
        // console.log(string, string.length);
        if (string.length == 0 || string.length == 2){
            return "NO FOLLOWERS";
        }
        // console.log(string)

        first_apost_split = string.split(";")[1];
        //console.log(first_apost_split)

        second_ampr_split = first_apost_split.split("&")[0];
        // console.log(second_ampr_split)

        return second_ampr_split
    }

    var all_friends = '{{ friends }}';
    var my_friend_Array = all_friends.split(" ");
    //console.log("NUM FOLLOWING:" + my_friend_Array.length);
    var name_array = []
    for (let i = 0; i < my_friend_Array.length; i++) {
        // console.log(i + ":  " + my_friend_Array[i]);
        name_array.push(get_wanted_string_following(my_friend_Array[i]));
    }

    var all_followers = '{{ followers }}';
    var my_followers_Array = all_followers.split(" ");
    //console.log("NUM FOLLOWERS:" + my_followers_Array.length);
    var follower_array = []
    for (let i = 0; i < my_followers_Array.length; i++) {
        // console.log(i + ":  " + my_friend_Array[i]);
        follower_array.push(get_wanted_string_followers(my_followers_Array[i]));
    }

    var globalVariable = {
        followers:follower_array,
        friends:name_array
    }




    // CHECKING WHO'S PROFILE IT IS TO SEE IF THERE NEEDS TO BE AN ADD USER SPOT
    // THE TRIPLE === COULD LEAD TO FUNKY BEHAVIOUR
    full_hostcheck_array = ('{{host_account}}');
    console.log(full_hostcheck_array)
    full_hostcheck_array_cleaned = full_hostcheck_array.slice(1, -1);
    console.log(full_hostcheck_array_cleaned)
    boolean_string = full_hostcheck_array_cleaned.split(",")[2].toLowerCase();
    console.log(boolean_string)
    host_profile = boolean_string.replace(/ /g,"");

    // CHECKING IF SO AND SO ALREADY FOLLOWS SO AND SO
    already_follows = full_hostcheck_array_cleaned.split(",")[3].toLowerCase().replace(/ /g,""); // unintelligble but correct
    console.log(already_follows)

    if (host_profile != "true") {
        if (already_follows == "true") {
            document.getElementById("non_host_add_remove").innerHTML = `

                <form action="/add_user/{{account_name}}" method="POST">
                    <button class="btn btn-primary"  name="add_user_button" type="submit" disabled>Follow {{account_name}}</button>
                </form>

                <form action="/remove_user/{{account_name}}" method="POST">
                    <button class="btn btn-primary" name="remove_user_button" type="submit">Unfollow {{account_name}}</button>
                </form>`
        } else {
            document.getElementById("non_host_add_remove").innerHTML = `

                <form action="/add_user/{{account_name}}" method="POST">
                    <button class="btn btn-primary" name="add_user_button" type="submit">Follow {{account_name}}</button>
                </form>

                <form action="/remove_user/{{account_name}}" method="POST">
                    <button class="btn btn-primary" name="remove_user_button" type="submit">Unfollow {{account_name}}</button>
                </form>`
        }


    }
    else {
        document.getElementById("add_new_profile_picture").innerHTML = `
            <form action="user_profile" method="POST" enctype="multipart/form-data">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" name="file" id="file">
                    <label class="custom-file-label" for="file">PROFILE PICTURE</label>
                </div>
                <button type="submit" class="btn btn-primary">Add New Picture</button>
            </form>
        `;
    }

    function enable_built_from_other() {
        if (document.getElementById("external_source").disabled == true) {
            document.getElementById('external_source').removeAttribute("disabled");

        }
        else {
            document.getElementById("external_source").setAttribute("disabled", "enabled")
        }

    }

    function enable_exteral_link() {
        // console.log("hello world")
        if (document.getElementById("external_source_link").disabled == true) { // if disabled
            document.getElementById('external_source_link').removeAttribute("disabled");

        }
        else {
            document.getElementById("external_source_link").setAttribute("disabled", "enabled")
        }
    
    }

    function reply_enable_external_link(){
        if (document.getElementById("reply_external_source_link").disabled == true) { // if disabled
            document.getElementById('reply_external_source_link').removeAttribute("disabled");
        }
        else {
            document.getElementById("reply_external_source_link").setAttribute("disabled", "enabled")
        }
    }

    function post_details_func() {
        console.log(document.getElementById("insert_post").innerHTML);
        if (document.getElementById("insert_post").innerHTML == "") {
            document.getElementById("insert_post").innerHTML = ``
        } else {
            document.getElementById("insert_post").innerHTML = ""
        }

    }
    
    function reply_modal_toggle(file_id) {
        // console.log(file_id)
        document.getElementById("reply_external_source").value = file_id;
        var modal = document.getElementById("reply_modal");
        modal.style.display = "block";
    }

    console.log("sadkjhflaskjdhflkasdfjh")
    /* THIS METHOD SEEMS TO NOT BE WORKING
    window.onclick = function (event) {
        console.log("clicked screen")
        var modal = document.getElementById("reply_modal");

        
        if ((event.target == modal)) {

            modal.style.display = "none";
        }
    }
    */
    document.onclick= function(event) {
        console.log("clicked screen")
        var modal = document.getElementById("reply_modal");
        if ((event.target == modal)) {

            modal.style.display = "none";
        }
    };




</script>
<script src="{{ url_for('static', filename='js/user_profile.js') }}"></script>
{% endblock main %}
